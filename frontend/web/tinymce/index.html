<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学級通信エディタ - TinyMCE</title>
    
    <!-- TinyMCE CDN (Community版) -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', 'MS PGothic', sans-serif;
            background-color: #f9f9f9;
        }
        
        .editor-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* 季節テーマ */
        .theme-spring { --primary-color: #8ED1FC; --secondary-color: #FFB3D1; }
        .theme-summer { --primary-color: #FFD93D; --secondary-color: #6BCF7F; }
        .theme-autumn { --primary-color: #FF9234; --secondary-color: #D2691E; }
        .theme-winter { --primary-color: #87CEEB; --secondary-color: #E6E6FA; }
        
        .content-style {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', 'MS PGothic', sans-serif;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .content-style h1 {
            color: var(--primary-color, #8ED1FC);
            text-align: center;
            border-bottom: 3px solid var(--primary-color, #8ED1FC);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        .content-style h2 {
            color: var(--secondary-color, #FFB3D1);
            border-left: 5px solid var(--secondary-color, #FFB3D1);
            padding-left: 15px;
            margin-top: 30px;
        }
        
        .content-style p {
            margin-bottom: 16px;
        }
        
        .content-style ul, .content-style ol {
            padding-left: 30px;
        }
        
        .content-style li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <textarea id="tinymce-editor" name="content">
            <h1>🌸 学級通信 🌸</h1>
            <p>こんにちは、保護者の皆様。</p>
            <p>今日は素晴らしい一日でした。子どもたちの笑顔がとても印象的でした。</p>
            
            <h2>📚 今日の学習</h2>
            <ul>
                <li>国語：漢字の練習をしました</li>
                <li>算数：かけ算の基礎を学びました</li>
                <li>体育：みんなで楽しく運動しました</li>
            </ul>
            
            <h2>📝 お知らせ</h2>
            <p>明日は遠足です。お弁当の準備をお願いします。</p>
            
            <p style="text-align: center; margin-top: 40px; color: #666;">
                <small>発行日: 2025年6月13日 | 担任: 〇〇先生</small>
            </p>
        </textarea>
    </div>

    <script>
        let editorInstance = null;
        let currentTheme = 'spring';
        
        // デバッグ情報
        console.log('🚀 [TinyMCE] スクリプト開始');
        console.log('🔍 [TinyMCE] tinymce オブジェクト:', typeof tinymce);
        
        // TinyMCE読み込み確認
        if (typeof tinymce === 'undefined') {
            console.error('❌ [TinyMCE] TinyMCEライブラリが読み込まれていません');
            alert('TinyMCEの読み込みに失敗しました。ネットワーク接続を確認してください。');
        } else {
            console.log('✅ [TinyMCE] TinyMCEライブラリ読み込み完了');
        }
        
        // TinyMCE初期化
        tinymce.init({
            selector: '#tinymce-editor',
            height: 600,
            // language: 'ja', // 一時的にコメントアウト
            
            // プラグイン設定
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount',
                'paste', 'autoresize'
            ],
            
            // ツールバー設定（日本語対応）
            toolbar: `
                undo redo | blocks fontsize |
                bold italic underline strikethrough | alignleft aligncenter alignright alignjustify |
                bullist numlist outdent indent | link image table |
                forecolor backcolor | removeformat | code preview
            `,
            
            // メニューバー非表示
            menubar: false,
            
            // 日本語フォント設定
            font_family_formats: `
                游ゴシック Medium=Yu Gothic Medium, YuGothic, sans-serif;
                ヒラギノ角ゴシック=Hiragino Kaku Gothic ProN, Hiragino Sans, sans-serif;
                メイリオ=Meiryo, sans-serif;
                MS Pゴシック=MS PGothic, sans-serif;
                Arial=arial,helvetica,sans-serif;
                Times New Roman=times new roman,times,serif
            `,
            
            // フォントサイズ設定
            fontsize_formats: "10px 11px 12px 14px 16px 18px 20px 24px 28px 32px 36px 48px",
            
            // コンテンツスタイル
            content_style: `
                .content-style {
                    font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', 'MS PGothic', sans-serif;
                    font-size: 14px;
                    line-height: 1.8;
                    color: #333;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }
                
                .content-style h1 {
                    color: var(--primary-color, #8ED1FC);
                    text-align: center;
                    border-bottom: 3px solid var(--primary-color, #8ED1FC);
                    padding-bottom: 10px;
                    margin-bottom: 30px;
                }
                
                .content-style h2 {
                    color: var(--secondary-color, #FFB3D1);
                    border-left: 5px solid var(--secondary-color, #FFB3D1);
                    padding-left: 15px;
                    margin-top: 30px;
                }
            `,
            
            // 貼り付け設定
            paste_as_text: false,
            paste_block_drop: false,
            paste_data_images: true,
            
            // 自動リサイズ
            autoresize_bottom_margin: 16,
            autoresize_min_height: 400,
            
            // セットアップ完了時の処理
            setup: function(editor) {
                editorInstance = editor;
                
                editor.on('init', function() {
                    console.log('📝 TinyMCEエディタが初期化されました');
                    
                    // 季節テーマ適用
                    applyTheme(currentTheme);
                    
                    // Flutter側に初期化完了を通知
                    if (window.parent && window.parent.postMessage) {
                        window.parent.postMessage({
                            type: 'tinymce_ready',
                            data: { status: 'ready' }
                        }, '*');
                    }
                });
                
                // コンテンツ変更イベント
                editor.on('change keyup', function() {
                    const content = editor.getContent();
                    
                    // Flutter側にHTML変更を通知
                    if (window.parent && window.parent.postMessage) {
                        window.parent.postMessage({
                            type: 'content_changed',
                            data: { html: content }
                        }, '*');
                    }
                });
            },
            
            // 初期設定
            init_instance_callback: function(editor) {
                console.log('✅ TinyMCEエディタが完全に初期化されました');
            }
        }).then(function(editors) {
            console.log('🎯 [TinyMCE] 初期化成功:', editors.length, 'エディタ');
        }).catch(function(error) {
            console.error('💥 [TinyMCE] 初期化エラー:', error);
            alert('エディタの初期化に失敗しました: ' + error.message);
        });
        
        // 季節テーマ適用関数
        function applyTheme(theme) {
            currentTheme = theme;
            document.body.className = `theme-${theme}`;
            
            // エディタ内のコンテンツにもテーマクラス適用
            if (editorInstance && editorInstance.getBody) {
                const editorBody = editorInstance.getBody();
                if (editorBody) {
                    editorBody.className = `content-style theme-${theme}`;
                }
            }
        }
        
        // Flutter側からのメッセージ受信
        window.addEventListener('message', function(event) {
            try {
                const message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                
                switch (message.type) {
                    case 'set_content':
                        if (editorInstance && message.data && message.data.html) {
                            editorInstance.setContent(message.data.html);
                        }
                        break;
                        
                    case 'get_content':
                        if (editorInstance) {
                            const content = editorInstance.getContent();
                            window.parent.postMessage({
                                type: 'content_response',
                                data: { html: content }
                            }, '*');
                        }
                        break;
                        
                    case 'set_theme':
                        if (message.data && message.data.theme) {
                            applyTheme(message.data.theme);
                        }
                        break;
                        
                    case 'insert_text':
                        if (editorInstance && message.data && message.data.text) {
                            editorInstance.insertContent(message.data.text);
                        }
                        break;
                }
            } catch (error) {
                console.error('❌ メッセージ処理エラー:', error);
            }
        });
        
        // エディタのフォーカス
        function focusEditor() {
            if (editorInstance) {
                editorInstance.focus();
            }
        }
        
        // エディタの内容をクリア
        function clearEditor() {
            if (editorInstance) {
                editorInstance.setContent('');
            }
        }
        
        // エディタの読み取り専用切り替え
        function setReadOnly(readOnly) {
            if (editorInstance) {
                editorInstance.setMode(readOnly ? 'readonly' : 'design');
            }
        }
    </script>
</body>
</html>