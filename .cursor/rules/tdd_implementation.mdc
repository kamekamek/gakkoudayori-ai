---
description: 
globs: 
alwaysApply: true
---
# TDDå®Ÿè£…ãƒ•ãƒ­ãƒ¼ãƒ«ãƒ¼ãƒ«

## ğŸ¯ åŸºæœ¬æ–¹é‡

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯**ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰**ã¨**è¦ä»¶å®šç¾©**ã‚’åŒæ™‚é€²è¡Œã§è¡Œã„ã€é«˜å“è³ªãªå­¦ç´šé€šä¿¡AIã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### æ ¸å¿ƒåŸå‰‡
- **è¦ä»¶å®šç¾© = ãƒ†ã‚¹ãƒˆå®šç¾©**: æ©Ÿèƒ½è¦ä»¶ã‚’æ›¸ãæ™‚ã¯å¿…ãšãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚‚åŒæ™‚å®šç¾©
- **TDDã‚µã‚¤ã‚¯ãƒ«å³å®ˆ**: Red â†’ Green â†’ Refactor ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
- **å°ã•ãªã‚¿ã‚¹ã‚¯åˆ†å‰²**: 1ã‚¿ã‚¹ã‚¯ = 1-2æ™‚é–“ã§å®Œäº†å¯èƒ½ãªç²’åº¦
- **å®Œäº†æ¡ä»¶æ˜ç¢ºåŒ–**: å„ã‚¿ã‚¹ã‚¯ã®æˆåŠŸåŸºæº–ã‚’äº‹å‰ã«å®šç¾©

## ğŸ“‹ ã‚¿ã‚¹ã‚¯å®šç¾©ãƒ•ãƒ­ãƒ¼

### 1. æ©Ÿèƒ½è¦ä»¶ + ãƒ†ã‚¹ãƒˆè¨­è¨ˆï¼ˆåŒæ™‚å®Ÿè¡Œï¼‰

æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã‚’**å¿…ãšåŒæ™‚**ã«è¡Œã†ï¼š

#### è¦ä»¶å®šç¾©
```markdown
## æ©Ÿèƒ½: éŸ³å£°å…¥åŠ›ã‹ã‚‰HTMLç”Ÿæˆ

### ç›®çš„
æ•™å¸«ãŒéŸ³å£°ã§è©±ã—ãŸå†…å®¹ã‚’å­¦ç´šé€šä¿¡HTMLã«å¤‰æ›ã™ã‚‹

### å…¥åŠ›
- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆwav/mp3, æœ€å¤§5MBï¼‰
- ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºï¼ˆä»»æ„ï¼‰
- å­£ç¯€ãƒ†ãƒ¼ãƒï¼ˆspring/summer/autumn/winterï¼‰

### å‡ºåŠ›  
- HTMLå½¢å¼ã®å­¦ç´šé€šä¿¡ãƒ‰ãƒ©ãƒ•ãƒˆ
- Quill.js Delta JSON
- ç”Ÿæˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆä¿¡é ¼åº¦ã€å‡¦ç†æ™‚é–“ï¼‰

### åˆ¶ç´„
- å‡¦ç†æ™‚é–“: 30ç§’ä»¥å†…
- å¯¾å¿œè¨€èª: æ—¥æœ¬èªã®ã¿
- è¨±å¯HTMLã‚¿ã‚°: h1,h2,h3,p,ul,ol,li,strong,em,br
```

#### ãƒ†ã‚¹ãƒˆè¨­è¨ˆï¼ˆåŒæ™‚å®šç¾©ï¼‰
```dart
// test/services/voice_to_html_service_test.dart

group('éŸ³å£°å…¥åŠ›ã‹ã‚‰HTMLç”Ÿæˆ', () {
  late VoiceToHtmlService service;
  
  setUp(() {
    service = VoiceToHtmlService();
  });

  test('æ­£å¸¸ãªéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰HTMLãŒç”Ÿæˆã•ã‚Œã‚‹', () async {
    // Given: æ­£å¸¸ãªéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«
    final audioFile = File('test/fixtures/sample_voice.wav');
    final request = VoiceToHtmlRequest(
      audioFile: audioFile,
      seasonTheme: 'spring',
    );
    
    // When: HTMLç”Ÿæˆã‚’å®Ÿè¡Œ
    final result = await service.generateHtml(request);
    
    // Then: æœŸå¾…ã•ã‚Œã‚‹çµæœ
    expect(result.isSuccess, true);
    expect(result.htmlContent, contains('<h1>'));
    expect(result.deltaJson, isNotEmpty);
    expect(result.processingTimeMs, lessThan(30000));
    expect(result.confidence, greaterThan(0.7));
  });

  test('å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹', () async {
    // Given: 5MBè¶…éã®ãƒ•ã‚¡ã‚¤ãƒ«
    final largeFile = File('test/fixtures/large_audio.wav');
    
    // When: HTMLç”Ÿæˆã‚’å®Ÿè¡Œ
    final result = await service.generateHtml(
      VoiceToHtmlRequest(audioFile: largeFile)
    );
    
    // Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
    expect(result.isFailure, true);
    expect(result.error, contains('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™'));
  });
});
```

### 2. ã‚¿ã‚¹ã‚¯åˆ†è§£ã¨å„ªå…ˆé †ä½

#### ã‚¿ã‚¹ã‚¯ç²’åº¦ã®åŸå‰‡
- **1ã‚¿ã‚¹ã‚¯ = 1-2æ™‚é–“**ã§å®Œäº†
- **1ã‚¿ã‚¹ã‚¯ = 1ã¤ã®æ˜ç¢ºãªä¾¡å€¤**ã‚’æä¾›
- **ä¾å­˜é–¢ä¿‚**ã‚’æ˜ç¢ºã«ç‰¹å®š
- **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•° â‰¤ 10å€‹**ç¨‹åº¦

#### å„ªå…ˆåº¦ä»˜ã‘
```markdown
### ğŸ”´ CRITICALï¼ˆå³åº§ã«å®Ÿè£…ï¼‰
- [ ] éŸ³å£°æ–‡å­—èµ·ã“ã—APIé€£æº
  - å®Œäº†æ¡ä»¶: Gemini APIã§ã®éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›æˆåŠŸ
  - ãƒ†ã‚¹ãƒˆ: æ­£å¸¸ã‚±ãƒ¼ã‚¹3ã¤ + ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹2ã¤
  - æ‰€è¦æ™‚é–“: 2æ™‚é–“

### ğŸŸ¡ HIGHï¼ˆä»Šé€±ä¸­ï¼‰  
- [ ] HTMLç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
  - å®Œäº†æ¡ä»¶: ãƒ†ã‚­ã‚¹ãƒˆâ†’HTMLå¤‰æ›ã€åˆ¶ç´„æº–æ‹ 
  - ãƒ†ã‚¹ãƒˆ: æ­£å¸¸ã‚±ãƒ¼ã‚¹5ã¤ + ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹3ã¤
  - æ‰€è¦æ™‚é–“: 3æ™‚é–“

### ğŸŸ¢ MEDIUMï¼ˆæ¥é€±ï¼‰
- [ ] å­£ç¯€ãƒ†ãƒ¼ãƒé©ç”¨æ©Ÿèƒ½
  - å®Œäº†æ¡ä»¶: 4å­£ç¯€ã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆé©ç”¨
  - ãƒ†ã‚¹ãƒˆ: å„å­£ç¯€1ã‚±ãƒ¼ã‚¹ãšã¤
  - æ‰€è¦æ™‚é–“: 1æ™‚é–“
```

## ğŸ”´ğŸŸ¢ğŸ”µ TDDã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œ

### Red Phaseï¼ˆå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ãï¼‰

```bash
# 1. ãƒ†ã‚¹ãƒˆä½œæˆ
cat > test/services/voice_service_test.dart << 'EOF'
test('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–‡å­—èµ·ã“ã—ã§ãã‚‹', () async {
  final service = VoiceService();
  final result = await service.transcribe(audioFile);
  expect(result.text, equals('äºˆæƒ³ã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆ'));
});
EOF

# 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå¤±æ•—ã‚’ç¢ºèªï¼‰
flutter test test/services/voice_service_test.dart
# Expected: 'VoiceService' class not found â† ã“ã‚Œã§OK
```

### Green Phaseï¼ˆæœ€å°é™ã®å®Ÿè£…ï¼‰

```dart
// lib/services/voice_service.dart
class VoiceService {
  Future<TranscriptionResult> transcribe(File audioFile) async {
    // æœ€å°é™ã®å®Ÿè£…ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ OKï¼‰
    return TranscriptionResult(text: 'äºˆæƒ³ã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆ');
  }
}

// ãƒ†ã‚¹ãƒˆå†å®Ÿè¡Œ
flutter test test/services/voice_service_test.dart
// âœ… 1 passing
```

### Blue Phaseï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰

```dart
// lib/services/voice_service.dart
class VoiceService {
  final GeminiApiClient _apiClient;
  
  VoiceService(this._apiClient);
  
  Future<TranscriptionResult> transcribe(File audioFile) async {
    // å®Ÿéš›ã®APIé€£æºã«æ”¹å–„
    final bytes = await audioFile.readAsBytes();
    final response = await _apiClient.transcribeAudio(bytes);
    
    return TranscriptionResult(
      text: response.text,
      confidence: response.confidence,
    );
  }
}
```

## ğŸ“Š å®Œäº†æ¡ä»¶ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å„ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã®å¿…é ˆç¢ºèªé …ç›®

#### âœ… æ©Ÿèƒ½è¦ä»¶
- [ ] è¦ä»¶å®šç¾©ã®å…¨é …ç›®ã‚’æº€ãŸã—ã¦ã„ã‚‹
- [ ] å…¥åŠ›ãƒ»å‡ºåŠ›ä»•æ§˜ã«100%æº–æ‹ 
- [ ] ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚‚é©åˆ‡ã«å‡¦ç†
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™å€¤ã‚’ã‚¯ãƒªã‚¢

#### âœ… ãƒ†ã‚¹ãƒˆå“è³ª
- [ ] å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒ passï¼ˆ100%ï¼‰
- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™é”æˆï¼ˆ85%ä»¥ä¸Šï¼‰
- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ»ç•°å¸¸ç³»ã®ãƒ†ã‚¹ãƒˆå®Ÿè£…
- [ ] æ‰‹å‹•ãƒ†ã‚¹ãƒˆã§ã‚‚å‹•ä½œç¢ºèª

#### âœ… ã‚³ãƒ¼ãƒ‰å“è³ª
- [ ] `flutter analyze` ã‚¨ãƒ©ãƒ¼ 0ä»¶
- [ ] `dart format` é©ç”¨æ¸ˆã¿
- [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
- [ ] é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

#### âœ… çµ±åˆç¢ºèª
- [ ] ä»–æ©Ÿèƒ½ã¨ã®é€£æºãƒ†ã‚¹ãƒˆé€šé
- [ ] UI/UXã«å•é¡Œãªã—
- [ ] [01_REQUIREMENT_overview.md](mdc:docs/01_REQUIREMENT_overview.md) ã¨ã®æ•´åˆæ€§ç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ãªã—

## ğŸ› ï¸ å®Ÿè£…æ™‚ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
```
test/
â”œâ”€â”€ unit/                    # å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ models/
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ widget/                  # ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ screens/
â”‚   â””â”€â”€ components/
â”œâ”€â”€ integration/             # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ e2e/
â””â”€â”€ fixtures/                # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    â”œâ”€â”€ audio/
    â”œâ”€â”€ json/
    â””â”€â”€ html/
```

### ãƒ†ã‚¹ãƒˆå‘½åè¦å‰‡
```dart
group('æ©Ÿèƒ½åï¼ˆæ—¥æœ¬èªï¼‰', () {
  test('æ­£å¸¸ç³»: æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã®èª¬æ˜', () async {});
  test('ç•°å¸¸ç³»: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®èª¬æ˜', () async {});
  test('å¢ƒç•Œå€¤: å¢ƒç•Œæ¡ä»¶ã®èª¬æ˜', () async {});
});
```

### ãƒ¢ãƒƒã‚¯ãƒ»ã‚¹ã‚¿ãƒ–æ´»ç”¨
```dart
// APIä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯åŒ–
class MockGeminiApiClient extends Mock implements GeminiApiClient {}

setUp(() {
  mockClient = MockGeminiApiClient();
  when(mockClient.transcribeAudio(any))
      .thenAnswer((_) async => TranscriptionResponse(text: 'ãƒ†ã‚¹ãƒˆçµæœ'));
});
```

## ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€£æº

### è¦ä»¶å¤‰æ›´æ™‚ã®æ›´æ–°ãƒ•ãƒ­ãƒ¼
1. **è¦ä»¶æ›¸æ›´æ–°**: [01_REQUIREMENT_overview.md](mdc:docs/01_REQUIREMENT_overview.md)
2. **ãƒ†ã‚¹ãƒˆæ›´æ–°**: æ–°è¦ä»¶ã«åˆã‚ã›ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ 
3. **å®Ÿè£…æ›´æ–°**: TDDã‚µã‚¤ã‚¯ãƒ«ã§å®Ÿè£…ä¿®æ­£
4. **è¨­è¨ˆæ›¸æ›´æ–°**: å½±éŸ¿ã™ã‚‹è¨­è¨ˆæ›¸ã®åŒæœŸæ›´æ–°

### é€²æ—ç®¡ç†
- æ¯æ—¥: [tasks.md](mdc:docs/tasks.md) ã®é€²æ—æ›´æ–°
- å®Œäº†æ™‚: ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå…¨é …ç›®ã®ç¢ºèªè¨˜éŒ²
- é€±æ¬¡: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ»å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª

## âš¡ åŠ¹ç‡åŒ–Tips

### é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
alias ft='flutter test'
alias fa='flutter analyze'  
alias ff='dart format .'

# ç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
flutter test --watch
```

### VS Codeè¨­å®š
```json
{
  "dart.runPubGetOnPubspecChanges": true,
  "dart.openDevTools": "flutter",
  "testing.automaticallyOpenPeekView": "never",
  "testing.openTesting": "neverOpen"
}
```

### CI/CDé€£æº
```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter test --coverage
      - run: flutter analyze
```

ã“ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã†ã“ã¨ã§ã€é«˜å“è³ªãªå­¦ç´šé€šä¿¡AIã‚·ã‚¹ãƒ†ãƒ ã‚’åŠ¹ç‡çš„ã«æ§‹ç¯‰ã§ãã¾ã™ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•ã«ã‚ˆã‚Šã€å®‰å¿ƒã—ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§ãã€è¦ä»¶å¤‰æ›´ã«ã‚‚è¿…é€Ÿã«å¯¾å¿œå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
