# Claude実装ルール - ゆとり職員室

このファイルはClaude Codeでの実装時に従うべきルールを定義します。

## 🎯 基本方針

### プロジェクト理解
- **目的**: HTMLベースグラレコ風学級通信作成システム（音声入力→AIチャット編集→グラレコ風HTML→PDF配信）
- **技術**: Flutter Web + FastAPI(Cloud Run?) + Google Cloud (Vertex AI Gemini・Speech-to-Text)
- **期間**: ハッカソンMVP（6週間・92タスク・4フェーズ）
- **ユーザー**: 小学校教師（IT初心者・2-3時間→20分短縮が目標）

### 実装優先順位（厳格遵守）
1. **🔴 HIGH**: システム基幹機能、他タスクブロッカー、ハッカソン必須機能（即座着手・完了まで集中）
2. **🟡 MEDIUM**: UX向上・品質確保・中重要度（HIGH完了後順次実施）
3. **🟢 LOW**: 最適化・拡張機能（MVP完成後の余裕時実施）

## 📋 タスク管理ルール（厳格運用）

### 基本方針
- **[tasks.md](docs/tasks.md)** を実装の中心管理ファイルとして使用
- **タスク完了時は必ず完了条件をすべて検証してからチェック**
- **実装順序は依存関係と優先度を考慮して決定**

### タスク完了プロセス

#### 1. 実装前確認
各タスクを開始する前に以下を確認：
- 依存するタスクが完了済みか
- 必要なリソース・ツールが準備できているか
- 完了条件が明確に定義されているか

#### 2. 実装中の管理
- コード変更は小さな単位で commit
- 機能実装と同時にテストコードも作成
- ドキュメント更新を忘れずに実施

#### 3. 完了条件検証（4条件すべて満たして初めて完了）
1. **✅ 機能実装**: コードが正常に動作し、期待される機能をすべて提供、エラーケースも適切に処理される
2. **✅ テスト通過**: 単体テストがすべてpass、統合テストで他機能との連携確認、手動テストで実際の使用シナリオを検証
3. **✅ 品質確認**: コードレビュー完了（可能であれば）、関連ドキュメントの更新完了、[system_design.md](docs/system_design.md)との整合性確認
4. **✅ 動作検証**: 実際の使用シナリオでテスト実行、パフォーマンス目標値を満たしている、ユーザビリティに問題がない

#### 4. チェックマーク更新
完了条件をすべて満たした場合のみ：
- [ ] → [x] に変更
- 進捗率を更新
- 完了日時をコメントで記録

### 優先度管理

#### 🔴 HIGH (最優先)
- システムの基幹機能
- 他タスクのブロッカーとなるもの
- ハッカソン要件の必須機能
- **即座に着手し、完了まで集中**

#### 🟡 MEDIUM (中優先度)  
- 重要だが緊急性は中程度
- ユーザビリティ向上に関わるもの
- **HIGH タスク完了後に順次実施**

#### 🟢 LOW (改善系)
- 最適化・改善系のタスク
- 追加機能・拡張機能
- **MVP完成後の余裕があるときに実施**

### 進捗報告

#### 週次レビュー
毎週以下を確認・更新：
- 完了したタスク数と進捗率
- 今週のフォーカスタスク
- 来週の計画
- ブロッカーや課題の特定

#### デイリー確認
毎日以下を実施：
- 今日完了予定のタスク確認
- 進行中タスクの状況把握
- 完了条件の再確認

### 作業フロー（毎回必須）
- **開始時**: `docs/tasks.md`確認→前回テスト通過確認→今日の機能テスト設計
- **実装時**: 🔴Red→🟢Green→🔵Refactor（TDDサイクル厳守）
- **終了時**: 成果確認→ドキュメント更新→`tasks.md`進捗更新→明日タスク明確化

### ファイル操作ルール
- **完了済みタスク変更禁止**: `docs/tasks.md`チェック済み項目の再編集厳禁
- **既存ファイル優先**: 新規作成より既存ファイル編集優先
- **小さなコミット**: 機能単位・日本語メッセージ（`[FEAT]`/`[FIX]`/`[DOCS]`等）
- **設定ファイル更新**: lint/typecheck必須実行

## 🏗️ 技術ルール・プロジェクト構造

### ディレクトリ構造（厳守）
```
yutorikyoshitu/
├── docs/                    # 設計書（REQUIREMENT.md・system_design.md・tasks.md中核）
├── frontend/lib/           # Flutter Web（models・services・widgets・screens・utils）
├── backend/app/            # FastAPI（api・models・services・utils）
├── infrastructure/         # インフラ as Code
└── .cursor/rules/          # Cursor ルール
```

### 命名規則（厳格遵守）
#### Flutter/Dart
- **ファイル・ディレクトリ**: `snake_case.dart`（models/document.dart、screens/dashboard_screen.dart）
- **クラス・列挙型**: `PascalCase`（DocumentModel、VoiceInputState）
- **変数・関数・フィールド**: `camelCase`（documentTitle、saveDocument()、isRecording）
- **定数**: `camelCase`（apiBaseUrl、voiceTimeout）

#### Python/FastAPI
- **ファイル・パッケージ**: `snake_case.py`（speech_service.py、document.py）
- **クラス**: `PascalCase`（DocumentService、SpeechService）
- **変数・関数**: `snake_case`（process_voice_input()、user_id）
- **定数**: `UPPER_SNAKE_CASE`（MAX_AUDIO_SIZE_MB、API_VERSION）

#### 共通
- **ドキュメント**: `snake_case.md`・`大文字_CASE.md`（REQUIREMENT.md等）
- **設定**: `kebab-case.yml`・アセット `kebab-case.png`

### アーキテクチャパターン（必須実装）
#### Flutter/Dart - MVVM + Provider
- **Provider状態管理**: ChangeNotifierを継承、適切なnotifyListeners()
- **Consumer使用**: ウィジェットでの状態購読、適切な再描画範囲
- **非同期処理**: mounted チェック必須、StreamSubscriptionの適切なdispose
- **エラーハンドリング**: try-catch + ログ + ユーザー通知

#### Python/FastAPI - レイヤードアーキテクチャ
- **型ヒント必須**: 完全な型注釈、Pydantic BaseModel使用
- **ルーター分離**: APIRouter使用、エンドポイント別ファイル分割
- **依存性注入**: Depends()でのサービス注入、設定の外部化
- **セキュリティ**: JWT認証、環境変数管理、入力値検証

### TDD適用箇所（必須・推奨・例外）
- **必須**: 音声認識・Geminiリライト・PDF生成・API・DB操作
- **推奨**: UIコンポーネント・ビジネスロジック
- **例外**: プロトタイプ・実験機能
- **カバレッジ目標**: 全体80%・重要機能90%・API95%

### Google Cloud統合（ハッカソン要件対応）
- **必須サービス**: Cloud Run・Vertex AI Gemini・Speech-to-Text
- **特別賞対象**: Flutter Web・Firebase（Authentication・Firestore・Storage）
- **セキュリティ**: 環境変数管理・最小権限・定期権限見直し

## 🚫 絶対禁止事項

### コード品質
- **完了済みタスクの変更・再実装**（チェック済み項目への干渉）
- **TDDサイクル無視**（コア機能のテストなし実装）
- **不適切なファイル作成**（既存構造無視・無駄な新規作成）
- **命名規則違反**（キャメルケース以外の使用、適切でない命名）
- **重複コード・長い関数**（DRY原則違反、単一責任原則違反）

### セキュリティ
- **機密情報ハードコード**（APIキー・設定値の直接記述）
- **セキュリティ軽視**（認証・認可・バリデーション省略）
- **入力値検証不備**（サニタイズ処理の省略）
- **HTTPS・CORS設定不備**（本番環境でのセキュリティ設定）

### Flutter/Dart 固有
- **mounted チェック省略**（非同期処理後のsetState呼び出し）
- **dispose処理不備**（StreamSubscription・Controller等のリーク）
- **Consumer使用不適切**（Provider状態の不適切な購読）
- **エラーハンドリング省略**（try-catch + ユーザー通知の不備）

### Python/FastAPI 固有
- **型ヒント省略**（関数・変数の型注釈必須）
- **環境変数未使用**（設定値のハードコード）
- **APIエンドポイント設計不備**（RESTful設計、適切なHTTPステータス）
- **Pydantic未使用**（リクエスト・レスポンスモデルの型安全性）

## ✅ 品質基準・デバッグフロー

### コード品質（必達）
- **静的解析**: lint/typecheck通過必須・破壊的変更慎重検証
- **可読性**: 適切なコメント・エラーハンドリング・日本語記述
- **セキュリティ**: 最小権限・入力値検証・依存関係脆弱性スキャン
- **アーキテクチャ**: Provider状態管理・レイヤード設計・型ヒント必須

### テスト品質  
- **テストカバレッジ**: 80% 以上
- **エッジケースのテスト**: 境界値・異常系の検証
- **実際の使用シナリオでの検証**: ユーザーストーリーベースのテスト
- **自動化可能なテストは自動化**: CI/CDパイプラインでの実行

### ドキュメント品質
- **実装内容と設計書の整合性**: コードと仕様の一致確認
- **API仕様の正確性**: OpenAPI/Swagger定義との整合性
- **ユーザーガイドの分かりやすさ**: 教師目線での操作説明
- **技術的な意思決定の記録**: アーキテクチャ決定記録（ADR）

### リスク管理

#### 技術的リスク
- **新しい技術の検証を早期実施**: PoC段階での検証
- **代替案を事前に準備**: バックアップ技術の調査
- **困ったときは早めに相談・調査**: ブロッカーの即座解決

#### スケジュールリスク
- **バッファ時間を確保**: 見積もりに余裕を持たせる
- **依存関係を明確化**: クリティカルパスの特定
- **ブロッカーは即座に解決**: 他タスクへの影響を最小化

#### 品質リスク
- **完了条件を妥協しない**: 4つの条件すべてを満たす
- **テストを軽視しない**: TDDサイクルの厳守
- **ユーザビリティを重視する**: 教師の使いやすさを最優先

### パフォーマンス目標
- **エディタ応答**: <100ms（リアルタイム編集）
- **PDF生成**: <3秒（WeasyPrint変換）
- **音声認識**: >95%精度（ノイズ抑制・ユーザー辞書）
- **Gemini API**: <500ms応答（リライト・見出し生成）

### UX・ユーザビリティ
- **20分完結**: 音声入力→編集→配信の全フロー
- **教師フレンドリー**: ワンタップ録音・直感UI・エラー時適切フィードバック
- **レスポンシブ**: スマートフォン・タブレット対応
- **アクセシビリティ**: 音声操作・大きなボタン・読み上げ対応

### デバッグ・トラブルシューティング
- **問題特定**: エラーメッセージ詳細確認→ログ調査→再現手順明確化
- **仮説検証**: 複数仮説立て→可能性高い順検証→小さな変更修正
- **よくある問題**: Flutter Web（キャッシュクリア・ビルド再実行）・API接続（認証・CORS・エンドポイント）・Gemini制限（リクエスト間隔・リトライ）

## 📚 実装時必須確認ドキュメント

### 作業開始前（必読）
- **`docs/tasks.md`**: 今日のタスク・完了条件・依存関係確認
- **`docs/REQUIREMENT.md`**: 機能要件・成功指標・制約事項
- **`docs/system_design.md`**: API仕様・データ設計・セキュリティ設計
- **`docs/tdd_guide.md`**: 具体的テスト例・カバレッジ目標

### 実装中（適宜参照）
- **`docs/README.md`**: プロジェクト全体ナビ・ドキュメント関係図
- **`.cursor/rules/`**: development_workflow・project_structure・task_management
- **`CODING_GUIDELINES.md`**: 詳細なコーディング規約・テスト戦略

## 📋 コードレビューチェックリスト

### 🔍 必須チェック項目（すべて満たす必要あり）

#### 機能・ロジック
- [ ] 要件定義通りの機能実装
- [ ] エッジケース・エラーケースの処理
- [ ] 適切なバリデーション実装
- [ ] セキュリティ脆弱性の検証

#### コード品質
- [ ] 命名規則遵守（ファイル・クラス・変数）
- [ ] 適切なコメント・ドキュメント
- [ ] 重複コード・長い関数の分割
- [ ] SOLID原則の適用

#### パフォーマンス
- [ ] 不要な再描画・再計算の回避
- [ ] 適切なキャッシュ戦略
- [ ] 非同期処理の最適化
- [ ] メモリリーク対策

#### テスト
- [ ] 単体テスト実装・実行成功
- [ ] カバレッジ80%以上達成
- [ ] 統合テスト実行成功
- [ ] エラーケースのテストカバー

#### セキュリティ
- [ ] API キー・機密情報のハードコード禁止
- [ ] 適切な認証・認可実装
- [ ] 入力値検証・サニタイズ
- [ ] HTTPS・CORS設定確認

### 🎯 Flutter/Dart 固有チェック項目
- [ ] Provider状態管理の適切な実装
- [ ] Consumer ウィジェットの適切な配置
- [ ] mounted チェック実装（非同期処理）
- [ ] StreamSubscription・Controller の dispose
- [ ] エラーハンドリング（try-catch + ユーザー通知）

### 🐍 Python/FastAPI 固有チェック項目
- [ ] 型ヒント完全実装
- [ ] Pydantic BaseModel使用
- [ ] 環境変数での設定管理
- [ ] APIRouter での適切なルーティング
- [ ] JWT認証・権限チェック実装

---

**🎯 最終目標: 先生が子どもと向き合う「ゆとり」を創出する学級通信システムの実現**
*このルールに従い、ハッカソンMVPとして価値ある実装を確実に提供する*