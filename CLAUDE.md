# Claude実装ルール - ゆとり職員室

このファイルはClaude Codeでの実装時に従うべきルールを定義します。

## 🎯 基本方針

### プロジェクト理解
- **目的**: HTMLベースグラレコ風学級通信作成システム（音声入力→AIチャット編集→グラレコ風HTML→PDF配信）
- **技術**: Flutter Web + FastAPI(Cloud Run?) + Google Cloud (Vertex AI Gemini・Speech-to-Text)
- **期間**: ハッカソンMVP（6週間・79タスク・4フェーズ）
- **ユーザー**: 小学校教師（IT初心者・2-3時間→20分短縮が目標）

### 実装優先順位（厳格遵守）
1. **🔴 HIGH**: システム基幹機能、他タスクブロッカー、ハッカソン必須機能（即座着手・完了まで集中）
2. **🟡 MEDIUM**: UX向上・品質確保・中重要度（HIGH完了後順次実施）
3. **🟢 LOW**: 最適化・拡張機能（MVP完成後の余裕時実施）

## 📋 タスク管理ルール（厳格運用）

### 4つの完了条件（すべて満たして初めて完了）
1. **✅ 機能実装**: コード動作・期待機能提供・エラーケース処理
2. **✅ テスト通過**: 単体・統合テスト成功（TDD必須）
3. **✅ 品質確認**: コードレビュー・ドキュメント更新・設計整合性
4. **✅ 動作検証**: 実使用シナリオ・パフォーマンス・ユーザビリティ

### 作業フロー（毎回必須）
- **開始時**: `docs/tasks.md`確認→前回テスト通過確認→今日の機能テスト設計
- **実装時**: 🔴Red→🟢Green→🔵Refactor（TDDサイクル厳守）
- **終了時**: 成果確認→ドキュメント更新→`tasks.md`進捗更新→明日タスク明確化

### ファイル操作ルール
- **完了済みタスク変更禁止**: `docs/tasks.md`チェック済み項目の再編集厳禁
- **既存ファイル優先**: 新規作成より既存ファイル編集優先
- **小さなコミット**: 機能単位・日本語メッセージ（`[FEAT]`/`[FIX]`/`[DOCS]`等）
- **設定ファイル更新**: lint/typecheck必須実行

## 🏗️ 技術ルール・プロジェクト構造

### ディレクトリ構造（厳守）
```
yutorikyoshitu/
├── docs/                    # 設計書（REQUIREMENT.md・system_design.md・tasks.md中核）
├── frontend/lib/           # Flutter Web（models・services・widgets・screens・utils）
├── backend/app/            # FastAPI（api・models・services・utils）
├── infrastructure/         # インフラ as Code
└── .cursor/rules/          # Cursor ルール
```

### 命名規則
- **ドキュメント**: `snake_case.md`・`大文字_CASE.md`（REQUIREMENT.md等）
- **Flutter**: `snake_case.dart`・Provider状態管理・MVVM アーキテクチャ
- **Python**: `snake_case.py`・型ヒント必須・レイヤードアーキテクチャ
- **設定**: `kebab-case.yml`・アセット `kebab-case.png`

### TDD適用箇所（必須・推奨・例外）
- **必須**: 音声認識・Geminiリライト・PDF生成・API・DB操作
- **推奨**: UIコンポーネント・ビジネスロジック
- **例外**: プロトタイプ・実験機能
- **カバレッジ目標**: 全体80%・重要機能90%・API95%

### Google Cloud統合（ハッカソン要件対応）
- **必須サービス**: Cloud Run・Vertex AI Gemini・Speech-to-Text
- **特別賞対象**: Flutter Web・Firebase（Authentication・Firestore・Storage）
- **セキュリティ**: 環境変数管理・最小権限・定期権限見直し

## 🚫 絶対禁止事項

- **完了済みタスクの変更・再実装**（チェック済み項目への干渉）
- **TDDサイクル無視**（コア機能のテストなし実装）
- **不適切なファイル作成**（既存構造無視・無駄な新規作成）
- **機密情報ハードコード**（APIキー・設定値の直接記述）
- **セキュリティ軽視**（認証・認可・バリデーション省略）

## ✅ 品質基準・デバッグフロー

### コード品質（必達）
- **静的解析**: lint/typecheck通過必須・破壊的変更慎重検証
- **可読性**: 適切なコメント・エラーハンドリング・日本語記述
- **セキュリティ**: 最小権限・入力値検証・依存関係脆弱性スキャン
- **アーキテクチャ**: Provider状態管理・レイヤード設計・型ヒント必須

### パフォーマンス目標
- **エディタ応答**: <100ms（リアルタイム編集）
- **PDF生成**: <3秒（WeasyPrint変換）
- **音声認識**: >95%精度（ノイズ抑制・ユーザー辞書）
- **Gemini API**: <500ms応答（リライト・見出し生成）

### UX・ユーザビリティ
- **20分完結**: 音声入力→編集→配信の全フロー
- **教師フレンドリー**: ワンタップ録音・直感UI・エラー時適切フィードバック
- **レスポンシブ**: スマートフォン・タブレット対応
- **アクセシビリティ**: 音声操作・大きなボタン・読み上げ対応

### デバッグ・トラブルシューティング
- **問題特定**: エラーメッセージ詳細確認→ログ調査→再現手順明確化
- **仮説検証**: 複数仮説立て→可能性高い順検証→小さな変更修正
- **よくある問題**: Flutter Web（キャッシュクリア・ビルド再実行）・API接続（認証・CORS・エンドポイント）・Gemini制限（リクエスト間隔・リトライ）

## 📚 実装時必須確認ドキュメント

### 作業開始前（必読）
- **`docs/tasks.md`**: 今日のタスク・完了条件・依存関係確認
- **`docs/REQUIREMENT.md`**: 機能要件・成功指標・制約事項
- **`docs/system_design.md`**: API仕様・データ設計・セキュリティ設計
- **`docs/tdd_guide.md`**: 具体的テスト例・カバレッジ目標

### 実装中（適宜参照）
- **`docs/README.md`**: プロジェクト全体ナビ・ドキュメント関係図
- **`.cursor/rules/`**: development_workflow・project_structure・task_management

---

**🎯 最終目標: 先生が子どもと向き合う「ゆとり」を創出する学級通信システムの実現**
*このルールに従い、ハッカソンMVPとして価値ある実装を確実に提供する*